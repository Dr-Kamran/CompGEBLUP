% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/04_cross_validation.R
\name{cv_gblup}
\alias{cv_gblup}
\title{Cross-Validation for GBLUP Models}
\usage{
cv_gblup(
  gdata,
  K_matrices = NULL,
  effects = "A",
  scheme = c("CV1", "CV2", "CV0"),
  n_folds = 5,
  n_reps = 1,
  ridge = 0.001,
  ridge_per_matrix = NULL,
  recompute_K = TRUE,
  verbose = TRUE,
  fixed = NULL
)
}
\arguments{
\item{gdata}{GBLUPData object}

\item{K_matrices}{List of relationship matrices (used only when recompute_K = FALSE)}

\item{effects}{Character vector of random effects to include}

\item{scheme}{Cross-validation scheme: "CV1" (random), "CV2" (leave-one-environment-out),
or "CV0" (within-environment)}

\item{n_folds}{Number of folds for CV0 and CV1 schemes}

\item{n_reps}{Number of replications}

\item{ridge}{Ridge parameter for numerical stability (scalar, applied to all matrices).
Overridden component-by-component by ridge_per_matrix when that argument is provided.}

\item{ridge_per_matrix}{Optional named numeric vector of per-matrix ridge values.
Names must match matrix types: "A", "D", "AA", "AE", "DE", "AAE".
Components not listed fall back to the scalar \code{ridge}.
Example: \code{ridge_per_matrix = c(A = 0.001, D = 0.05, AA = 0.05)}.
Only used when \code{recompute_K = TRUE}. This is the correct way to apply
differential regularisation (e.g. stronger ridge on ill-conditioned D or AA)
without weakening the baseline A matrix regularisation.}

\item{recompute_K}{Logical, if TRUE (default) recomputes K matrix for each fold using
only training individuals. This prevents data leakage from test genotypes but is slower.
If FALSE, uses pre-computed K_matrices for all folds (faster but allows minor leakage).}

\item{verbose}{Logical, print progress messages}

\item{fixed}{Optional fixed effects specification. Can be NULL (intercept only, default),
a one-sided formula (e.g., ~ TESTER), or a pre-built design matrix. Fixed effects
are applied to the training data in each fold.}
}
\value{
CVResult object containing:
\item{metrics}{Data frame with predictive_ability and MSE per fold}
\item{predictions}{Data frame with predicted vs observed values}
}
\description{
Performs k-fold cross-validation for genomic prediction models.
}
\details{
The returned metrics include:
\itemize{
\item \strong{predictive_ability}: Correlation between predicted GEBVs and observed
phenotypes, cor(GEBV, y). This is THE standard metric reported in genomic prediction
literature. A value of ~0.4 is typical for small training populations.
\item \strong{MSE}: Mean squared error of predictions
}

Note: "Predictive ability" (correlation with phenotype) differs from "prediction accuracy"
(correlation with true breeding value). The theoretical relationship is:
accuracy = predictive_ability / sqrt(h²). However, this conversion requires knowing the
TRUE heritability. Using estimated h² from training data produces unreliable results.

For theoretical comparisons, use \code{expected_accuracy()} to estimate the theoretical
maximum accuracy based on training population size and known h².

Cross-validation schemes:
\itemize{
\item \strong{CV1}: Random k-fold - standard evaluation of genomic prediction
\item \strong{CV2}: Leave-one-environment-out - evaluates prediction to new environments
\item \strong{CV0}: Within-environment - evaluates prediction within each environment
}
}
\examples{
\dontrun{
gdata <- simulate_genotypes(n_ind = 100, n_snp = 500)
gdata <- simulate_phenotypes(gdata, n_env = 3, h2 = 0.6)
K <- calc_relationship_matrices(gdata, matrices = "A")

# Run CV - reports predictive ability (the standard GP metric)
cv_res <- cv_gblup(gdata, K, effects = "A", scheme = "CV1", n_folds = 5)

# With fixed effects
cv_res_fixed <- cv_gblup(gdata, K, effects = "A", fixed = ~ TESTER, 
                         scheme = "CV1", n_folds = 5)

# Compare to theoretical maximum (requires knowing true h² and Me)
# With Me=500, theoretical max is ~0.30; with Me=100, it's ~0.57
expected_accuracy(n_train = 80, h2 = 0.6, Me = 100)

# Convert to accuracy only if you know the TRUE h² (e.g., from simulation)
calc_prediction_accuracy(cv_res@metrics$predictive_ability, h2 = 0.6)
}
}
