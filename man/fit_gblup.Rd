% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/03_model_fitting.R
\name{fit_gblup}
\alias{fit_gblup}
\title{Fit GBLUP Model}
\usage{
fit_gblup(
  gdata,
  K_matrices,
  effects = "A",
  ridge = 0.001,
  ridge_per_matrix = NULL,
  nIters = 100,
  tolParConvLL = 1e-04,
  verbose = TRUE,
  use.emma = TRUE,
  use.sparse = FALSE,
  K_already_regularized = FALSE,
  fixed = NULL
)
}
\arguments{
\item{gdata}{GBLUPData object}

\item{K_matrices}{List of relationship matrices}

\item{effects}{Character vector of random effects to include}

\item{ridge}{Ridge parameter for numerical stability (default: 0.001).
Applied uniformly to all K matrices unless \code{ridge_per_matrix} is provided.}

\item{ridge_per_matrix}{Optional named numeric vector of per-matrix ridge values.
When provided, each K matrix receives its designated ridge value instead of the
scalar \code{ridge}. Names must match effect names (e.g. "A", "D", "AA", "AE").
Effects not listed fall back to the scalar \code{ridge}.
Example: \code{ridge_per_matrix = c(A = 0.001, D = 0.05, AA = 0.05)}.}

\item{nIters}{Maximum iterations for REML (default: 100). Increase for complex
models with 3+ random effects if convergence warnings occur.}

\item{tolParConvLL}{Convergence tolerance}

\item{verbose}{Logical, print progress messages}

\item{use.emma}{Control solver selection (default TRUE).
When TRUE: auto-selects the fastest solver (EMMA for single-effect small n,
Henderson EM-REML for large n >> q). When FALSE: uses Newton-based solvers
(Henderson AI-REML for large n >> q, observation-space AI-REML for small n).
Set to FALSE if variance estimates drift or fail to converge with the default.}

\item{use.sparse}{Use sparse matrices for design matrices (default FALSE)}

\item{K_already_regularized}{Logical, if TRUE skips adding ridge to K matrices.
Set to TRUE if K matrices were already regularized via make_positive_definite()
to avoid double regularization.}

\item{fixed}{Optional fixed effects specification. Can be NULL (intercept only, default),
a one-sided formula (e.g., ~ TESTER or ~ TESTER + BLOCK) referencing columns in
gdata@phenotypes, or a pre-built design matrix. When provided, fixed effects are
estimated jointly with random effects in the mixed model.}
}
\value{
GBLUPModel object
}
\description{
Fits a Genomic Best Linear Unbiased Prediction (GBLUP) model
using the internal REML-based mixed model engine with optional
EMMA-style efficient algorithm for single random effect models.
}
\examples{
\dontrun{
gdata <- simulate_genotypes(n_ind = 100, n_snp = 500)
gdata <- simulate_phenotypes(gdata, n_env = 3, h2 = 0.6)
K <- calc_relationship_matrices(gdata, matrices = "A")
model <- fit_gblup(gdata, K, effects = "A")
summary(model)

# With differential ridge
model_diff <- fit_gblup(gdata, K, effects = c("A", "D"),
                        ridge_per_matrix = c(A = 0.001, D = 0.05))
}
}
